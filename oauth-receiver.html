<link rel="import" href="url-search-params-polyfill.html">

<script>
    /**
     * `oauth-receiver`
     *
     * The second part of the OAuth-Element story, that receives the authentication
     * data in the redirected window and sends them back to the window opener via
     * `window.postMessage`.
     *
     * @customElement
     */
    class OAuthReceiver extends HTMLElement {
        static get is() {
            return 'oauth-receiver';
        }

        connectedCallback() {
            if (!this.hasAttribute('manual')) {
                this.receive();
            }
        }

        /**
         * Attempts to read OAuth2 authentication parameters and sends them off
         * to the window opener through `window.postMessage`.
         *
         * @returns {boolean} whether the parameters could be sent to the window opener.
         */
        receive() {
            if (!window.opener) {
                console.log("Missing window.opener.");
                return false;
            }

            const attrValue = this.getAttribute('target');
            const query = new URLSearchParams(document.location.search);

            const code = query.get('code');
            const error = query.get('error');
            const state = query.get('state');

            if (!code && !error) {
                console.log("Missing OAuth2 GET parameters.");
                return false;
            }

            window.opener.postMessage(
                { code: code, error: error, state: state },
                this.target ? this.target : attrValue ? attrValue : '*'
            );

            return true;
        }
    }

    customElements.define(OAuthReceiver.is, OAuthReceiver);
</script>