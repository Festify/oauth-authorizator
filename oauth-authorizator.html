<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="url-polyfill.html">

<dom-module id="oauth-authorizator">
    <template>
        <iron-ajax id="exchangeAjax"
                   content-type="application/x-www-form-urlencoded"
                   handle-as="json"
                   headers="[[headers]]"
                   method="post"
                   url="[[tokenExchangeUrl]]">
        </iron-ajax>
    </template>
</dom-module>

<script>
    /**
     * `oauth-authorizator`
     *
     * A Polymer 2.0 Element that performs the OAuth2 authorization code flow.
     *
     * @customElement
     * @polymer
     */
    class OauthAuthorizator extends Polymer.Element {
        static get errors() {
            return {
                AUTH_WINDOW_CLOSED: 'auth_window_closed',
                HTTP_ERROR: 'http',
                INVALID_PARAMETER: 'parameter',
                OAUTH_ERROR: 'oauth_error',
                STATE_MISMATCH: 'state_mismatch',
                UNKOWN: 'unknown'
            };
        }

        static get is() {
            return 'oauth-authorizator';
        }

        static get properties() {
            return {
                /**
                 * The authorization endpoint.
                 *
                 * E.g. https://accounts.spotify.com/authorize
                 *
                 * @type String
                 */
                authorizationUri: {
                    type: String
                },

                /**
                 * The client ID.
                 *
                 * @type String
                 */
                clientId: {
                    type: String
                },

                /**
                 * Custom headers to send to the token exchange service.
                 *
                 * Setting a `Content-Type` header here will override how the request
                 * body is encoded during the request to the token exchange service.
                 *
                 * @type Object
                 */
                headers: {
                    type: Object
                },

                /**
                 * The URI to redirect to when the authorization has completed.
                 *
                 * @type String
                 */
                redirectUri: {
                    type: String
                },

                /**
                 * The authorization scopes to request.
                 *
                 * @type String[]
                 */
                scopes: {
                    type: Array
                },

                /**
                 * The URI exchange the authorization code into a full access token through.
                 *
                 * @type String
                 */
                tokenExchangeUrl: {
                    type: String
                }
            };
        }

        /**
         * Performs the OAuth authorization and yields back the
         * authorization data.
         */
        authenticate() {
            if (!this.authorizationUri) {
                throw new Error(
                    "Authentication URL is null or empty!",
                    OauthAuthorizator.errors.INVALID_PARAMETER
                );
            }
            if (!this.redirectUri) {
                throw new Error(
                    "Redirect URL is null or empty!",
                    OauthAuthorizator.errors.INVALID_PARAMETER
                );
            }
            if (!this.tokenExchangeUrl) {
                throw new Error(
                    "Token exchange URL is null or empty!",
                    OauthAuthorizator.errors.INVALID_PARAMETER
                );
            }

            // Generate random ASCII string
            const state = (Math.random().toString(36) + '00000000000000000').slice(2, 9);

            return new Promise((res, rej) => {
                const authUrl = new URL(this.authorizationUri);
                authUrl.searchParams.set('client_id', this.clientId);
                authUrl.searchParams.set('redirect_uri', this.redirectUri);
                authUrl.searchParams.set('response_type', 'code');
                authUrl.searchParams.set('scope', (this.scopes || []).join(' '));
                authUrl.searchParams.set('state', state);

                const w = window.open(authUrl.toString());
                if (!w) {
                    return rej(new Error(
                        "Window handle was null.",
                        OauthAuthorizator.errors.UNKNOWN
                    ));
                }

                const redirUrl = new URL(this.redirectUri);
                const i = setInterval(() => {
                    if (w.closed) {
                        clearInterval(i);
                        return rej(new Error(
                            "Authorization window has been closed.",
                            OauthAuthorizator.errors.AUTH_WINDOW_CLOSED
                        ));
                    }

                    if (!w.location) {
                        clearInterval(i);
                        return rej(new Error(
                            "Window location was null.",
                            OauthAuthorizator.errors.UNKNOWN
                        ));
                    }

                    const loc = new URL(w.location);
                    if (loc.protocol !== redirUrl.protocol ||
                        loc.host !== redirUrl.host ||
                        loc.pathname !== redirUrl.pathname) {
                        return;
                    }

                    clearInterval(i);
                    w.close();
                    const code = loc.searchParams.get('code');
                    const error = loc.searchParams.get('error');
                    const s = loc.searchParams.get('state');

                    if (s !== state) {
                        return rej(new Error(
                            "State value didn't match.",
                            OauthAuthorizator.errors.STATE_MISMATCH
                        ));
                    }
                    if (error) {
                        return rej(new Error(
                            error,
                            OauthAuthorizator.errors.OAUTH_ERROR
                        ));
                    }

                    res(code);
                }, 100);
            })
                .then(code => {
                    this.$.exchangeAjax.body = { code: encodeURIComponent(code) };
                    return this.$.exchangeAjax.generateRequest().completes;
                })
                .then(xhr => xhr.response)
                .catch(err => Promise.reject(new Error(err, OauthAuthorizator.errors.HTTP_ERROR)));
        }
    }

    window.customElements.define(OauthAuthorizator.is, OauthAuthorizator);
</script>