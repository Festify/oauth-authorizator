<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<script src="../url/url.js"></script>

<dom-module id="oauth-authorizator">
    <template>
        <iron-ajax id="exchangeAjax"
                   content-type="application/x-www-form-urlencoded"
                   handle-as="json"
                   headers="[[headers]]"
                   method="post"
                   url="[[tokenExchangeUrl]]">
        </iron-ajax>
    </template>
</dom-module>

<script>
    /**
     * `oauth-authorizator`
     *
     * A Polymer 2.0 Element that performs the OAuth2 authorization code flow.
     *
     * @customElement
     * @polymer
     */
    class OauthAuthorizator extends Polymer.Element {
        static get errors() {
            return {
                AUTH_WINDOW_CLOSED: -1,
                HTTP_ERROR: -2,
                INVALID_PARAMETER: -3,
                OAUTH_ERROR: -4,
                STATE_MISMATCH: -5
            };
        }

        static get is() {
            return 'oauth-authorizator';
        }

        static get properties() {
            return {
                /**
                 * The authorization endpoint.
                 *
                 * E.g. https://accounts.spotify.com/authorize
                 *
                 * @type String
                 */
                authorizationUri: {
                    type: String
                },

                /**
                 * The client ID.
                 *
                 * @type String
                 */
                clientId: {
                    type: String
                },

                /**
                 * Custom headers to send to the token exchange service.
                 *
                 * WARNING: DO NOT set a `Content-Type` header here, as it will mess
                 * with the POST data.
                 *
                 * @type Object
                 */
                headers: {
                    type: Object
                },

                /**
                 * The URI to redirect to when the authorization has completed.
                 *
                 * @type String
                 */
                redirectUri: {
                    type: String
                },

                /**
                 * The authorization scopes to request.
                 *
                 * @type String[]
                 */
                scopes: {
                    type: Array
                },

                /**
                 * The URI exchange the authorization code into a full access token through.
                 *
                 * @type String
                 */
                tokenExchangeUrl: {
                    type: String
                }
            };
        }

        /**
         * Performs the OAuth authorization and yields back the
         * authorization data.
         */
        authenticate() {
            if (!this.authorizationUri) {
                throw new Error({
                    code: OauthAuthorizator.errors.INVALID_PARAMETER,
                    msg: "Authentication URL is null or empty!"
                });
            }
            if (!this.redirectUri) {
                throw new Error({
                    code: OauthAuthorizator.errors.INVALID_PARAMETER,
                    msg: "Redirect URL is null or empty!"
                });
            }
            if (!this.tokenExchangeUrl) {
                throw new Error({
                    code: OauthAuthorizator.errors.INVALID_PARAMETER,
                    msg: "Token exchange URL is null or empty!"
                });
            }

            const authUrl = new URL(this.authorizationUri);
            const state = (Math.random().toString(36) + '00000000000000000').slice(2, 9);

            return new Promise((res, rej) => {
                const u = new URL(this.authorizationUri);
                u.searchParams.set('client_id', this.clientId);
                u.searchParams.set('redirect_uri', this.redirectUri);
                u.searchParams.set('response_type', 'code');
                u.searchParams.set('scope', (this.scopes || []).join(' '));
                u.searchParams.set('state', state);

                const w = window.open(u.toString());
                const i = setInterval(() => {
                    if (w.closed) {
                        clearInterval(i);
                        return rej(new Error({
                            code: OauthAuthorizator.errors.AUTH_WINDOW_CLOSED,
                            msg: "Authorization window has been closed."
                        }));
                    }

                    if (!w.location.href) {
                        return;
                    }

                    const loc = new URL(w.location.href);
                    if (loc.protocol !== authUrl.protocol ||
                        loc.host !== authUrl.host ||
                        loc.pathname !== authUrl.pathname) {
                        return;
                    }

                    clearInterval(i);
                    w.close();
                    const code = loc.searchParams.get('code');
                    const error = loc.searchParams.get('error');
                    const s = loc.searchParams.get('state');

                    if (s !== state) {
                        return rej(new Error({
                            code: OauthAuthorizator.errors.STATE_MISMATCH,
                            msg: "State value didn't match."
                        }));
                    }
                    if (error) {
                        return rej(new Error({
                            code: OauthAuthorizator.errors.OAUTH_ERROR,
                            msg: error
                        }));
                    }

                    res(code);
                }, 100);
            })
                .then(code => {
                    this.$.exchangeAjax.body = 'code=&' + encodeURIComponent(code);
                    return this.$.exchangeAjax.generateRequest().completes;
                })
                .then(xhr => xhr.response)
                .catch(err => Promise.reject({
                    code: OauthAuthorizator.errors.HTTP_ERROR,
                    msg: err
                }));
        }
    }

    window.customElements.define(OauthAuthorizator.is, OauthAuthorizator);
</script>